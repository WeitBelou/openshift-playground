---
# Manage subscription
- hosts: ansible-controller
  become: true

  vars_files:
    - ../credentials.yml

  tasks:
    - name: Install subscription-manager
      yum:
        name: subscription-manager

    - name: Enable registration
      redhat_subscription:
        state: present
        username: "{{ redhat_username }}"
        password: "{{ redhat_password }}"
        auto_attach: true

    - name: Disable all RHSM repositories
      rhsm_repository:
        name: '*'
        state: disabled

    - name: Enable repos
      rhsm_repository:
        name: "{{ item }}"
        state: enabled
      with_items: "{{ redhat_repos }}"

# Modify repos list
- hosts: openshift
  become: true

  handlers:
    - name: yum-clean-metadata
      command: yum clean metadata
      args:
        warn: no

  tasks:
    - name: Disable epel repos
      yum_repository:
        name: "{{ item }}"
        file: epel
        state: absent
      with_items:
        - epel
        - epel-debuginfo
        - epel-source
      notify: yum-clean-metadata

    - name: Disable epel-testing repos
      yum_repository:
        name: "{{ item }}"
        file: epel-testing
        state: absent
      with_items:
        - epel-testing
        - epel-testing-debuginfo
        - epel-testing-source
      notify: yum-clean-metadata

    - name: Disable google-cloud repos
      yum_repository:
        name: "{{ item }}"
        file: google-cloud
        state: absent
      with_items:
        - google-cloud-compute
        - google-cloud-sdk
      notify: yum-clean-metadata

    - name: Disable default rhel cloud repos
      yum_repository:
        name: "{{ item }}"
        file: rh-cloud
        state: absent
      with_items:
        - rhui-rhel-7-server-rhui-extras-rpms
        - rhui-rhel-7-server-rhui-optional-rpms
        - rhui-rhel-7-server-rhui-rh-common-rpms
        - rhui-rhel-7-server-rhui-rpms
        - rhui-rhel-7-server-rhui-supplementary-rpms
        - rhui-rhel-ha-for-rhel-7-server-rhui-rpms
        - rhui-rhel-rs-for-rhel-7-server-rhui-rpms
        - rhui-rhel-server-rhui-rhscl-7-rpms
      notify: yum-clean-metadata

    - name: Add repos to list
      yum_repository:
        name: "{{ item }}"
        description: "{{ item }}"
        baseurl: http://{{ yum_repo_ip }}/repos/{{ item }}
        gpgcheck: false
        enabled: true
        file: ose
      with_items: "{{ redhat_repos }}"

# Update hosts
- hosts: all
  become: true

  tasks:
    - name: Add mappings to /etc/hosts
      blockinfile:
        path: /etc/hosts
        block: |
          {{ item.ip }} {{ item.name }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.name }}"
      with_items:
        - { name: openshift-master.internal, ip: "{{ hostvars['openshift-master.internal']['ansible_host'] }}" }
        - { name: openshift-node-1.internal, ip: "{{ hostvars['openshift-node-1.internal']['ansible_host'] }}" }
        - { name: openshift-node-2.internal, ip: "{{ hostvars['openshift-node-2.internal']['ansible_host'] }}" }

# Generate inventory
- hosts: ansible-controller
  become: true

  tasks:
    - name: Generate inventory file
      template:
        src: templates/inventory.j2
        dest: /etc/ansible/hosts
