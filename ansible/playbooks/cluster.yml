---
- hosts: openshift
  become: true

  tasks:
    - name: Add repos to list
      become: true
      yum_repository:
        name: "{{ item }}"
        baseurl: http://{{ internal_yum_repo_ip }}/repos/{{ item }}
        gpgcheck: false
        enabled: true
        file: ose
      with_items:
        - rhel-7-server-rpms
        - rhel-7-server-extras-rpms
        - rhel-7-server-ansible-2.6-rpms
        - rhel-7-server-ose-3.11-rpms

    - name: Add mappings to /etc/hosts
      blockinfile:
        path: /etc/hosts
        block: |
          {{ item.ip }} {{ item.name }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.name }}"
      with_items:
        - { name: master.openshift, ip: "{{ hostvars['master.openshift']['ansible_host'] }}" }
        - { name: node-1.openshift, ip: "{{ hostvars['node-1.openshift']['ansible_host'] }}" }
        - { name: node-2.openshift, ip: "{{ hostvars['node-2.openshift']['ansible_host'] }}" }

    - name: Install base packages
      become: true
      yum:
        state: latest
        name:
          - wget
          - git
          - net-tools
          - bind-utils
          - yum-utils
          - iptables-services
          - bridge-utils
          - bash-completion
          - kexec-tools
          - sos
          - psacct

    - name: Reboot
      become: true
      reboot:

    - name: Install openshift-ansible
      become: true
      yum:
        state: latest
        name: openshift-ansible

    - name: Install docker
      become: true
      yum:
        state: present
        name: docker-1.13.1